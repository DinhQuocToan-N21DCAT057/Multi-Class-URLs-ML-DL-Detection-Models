{% extends "base.html" %}

{% block title %}Cài đặt - URL Multi-Labels Detection{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="glass-card">
                <div class="text-center mb-4">
                    <i class="fas fa-cog settings-icon"></i>
                    <h2 class="fw-bold mb-3">Cài đặt hệ thống</h2>
                    <p class="text-muted">Tùy chỉnh các thông số và cấu hình mô hình</p>
                </div>

                <!-- Settings Form -->
                <form id="settingsForm">
                    <div class="row">
                        <!-- Model Configuration -->
                        <div class="col-12">
                            <h5 class="mb-3">
                                <i class="fas fa-brain me-2 text-primary"></i>
                                Cấu hình mô hình
                            </h5>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="defaultModel" class="form-label">Mô hình mặc định</label>
                                <select class="form-select" id="defaultModel">
                                    <option value="cnn">CNN (Khuyến nghị)</option>
                                    <option value="xgb">XGBoost</option>
                                    <option value="rf">Random Forest</option>
                                </select>
                                <div class="form-text">Mô hình được sử dụng cho dự đoán nhanh</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="defaultDataset" class="form-label">Dataset mặc định</label>
                                <select class="form-select" id="defaultDataset">
                                    <option value="dataset_1">Dataset 1</option>
                                    <option value="dataset_2">Dataset 2</option>
                                    <option value="dataset_3">Dataset 3</option>
                                </select>
                                <div class="form-text">Dataset được sử dụng cho các mô hình</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Threshold Settings -->
                        <div class="col-12">
                            <h5 class="mb-3 mt-4">
                                <i class="fas fa-sliders-h me-2 text-primary"></i>
                                Ngưỡng dự đoán
                            </h5>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="cnnThreshold" class="form-label">
                                    CNN Threshold: <span id="cnnThresholdValue">50%</span>
                                </label>
                                <input type="range" 
                                       class="form-range threshold-range" 
                                       id="cnnThreshold" 
                                       min="10" 
                                       max="90" 
                                       value="50"
                                       data-target="cnnThresholdValue">
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="xgbThreshold" class="form-label">
                                    XGBoost Threshold: <span id="xgbThresholdValue">50%</span>
                                </label>
                                <input type="range" 
                                       class="form-range threshold-range" 
                                       id="xgbThreshold" 
                                       min="10" 
                                       max="90" 
                                       value="50"
                                       data-target="xgbThresholdValue">
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="rfThreshold" class="form-label">
                                    RF Threshold: <span id="rfThresholdValue">50%</span>
                                </label>
                                <input type="range" 
                                       class="form-range threshold-range" 
                                       id="rfThreshold" 
                                       min="10" 
                                       max="90" 
                                       value="50"
                                       data-target="rfThresholdValue">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Model Enable/Disable -->
                        <div class="col-12">
                            <h5 class="mb-3 mt-4">
                                <i class="fas fa-toggle-on me-2 text-primary"></i>
                                Bật/Tắt mô hình
                            </h5>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="model-toggle-card">
                                <div class="model-icon">
                                    <i class="fas fa-network-wired"></i>
                                </div>
                                <h6>CNN Model</h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableCNN" checked>
                                    <label class="form-check-label" for="enableCNN">
                                        Kích hoạt
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="model-toggle-card">
                                <div class="model-icon">
                                    <i class="fas fa-tree"></i>
                                </div>
                                <h6>XGBoost</h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableXGB" checked>
                                    <label class="form-check-label" for="enableXGB">
                                        Kích hoạt
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="model-toggle-card">
                                <div class="model-icon">
                                    <i class="fas fa-forest"></i>
                                </div>
                                <h6>Random Forest</h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableRF" checked>
                                    <label class="form-check-label" for="enableRF">
                                        Kích hoạt
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- System Settings -->
                        <div class="col-12">
                            <h5 class="mb-3 mt-4">
                                <i class="fas fa-cogs me-2 text-primary"></i>
                                Cài đặt hệ thống
                            </h5>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maxHistoryDays" class="form-label">Lưu lịch sử (ngày)</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="maxHistoryDays" 
                                       value="30" 
                                       min="1" 
                                       max="365">
                                <div class="form-text">Số ngày lưu trữ lịch sử dự đoán</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maxConcurrentRequests" class="form-label">Số request đồng thời</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="maxConcurrentRequests" 
                                       value="10" 
                                       min="1" 
                                       max="100">
                                <div class="form-text">Số lượng request tối đa cùng lúc</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="autoSave" checked>
                                <label class="form-check-label" for="autoSave">
                                    <i class="fas fa-save me-2"></i>
                                    Tự động lưu kết quả vào Firebase
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="enableNotifications" checked>
                                <label class="form-check-label" for="enableNotifications">
                                    <i class="fas fa-bell me-2"></i>
                                    Bật thông báo
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="enableLogging" checked>
                                <label class="form-check-label" for="enableLogging">
                                    <i class="fas fa-file-alt me-2"></i>
                                    Ghi log chi tiết
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="enableCache" checked>
                                <label class="form-check-label" for="enableCache">
                                    <i class="fas fa-memory me-2"></i>
                                    Kích hoạt cache
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-outline-secondary me-3" onclick="resetSettings()">
                            <i class="fas fa-undo me-2"></i>
                            Đặt lại mặc định
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            Lưu cài đặt
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Settings Export/Import Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-download me-2"></i>
                    Xuất/Nhập cài đặt
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <button class="btn btn-outline-primary w-100 mb-2" onclick="exportSettings()">
                        <i class="fas fa-download me-2"></i>
                        Xuất cài đặt ra file JSON
                    </button>
                    <button class="btn btn-outline-success w-100" onclick="importSettings()">
                        <i class="fas fa-upload me-2"></i>
                        Nhập cài đặt từ file JSON
                    </button>
                </div>
                <input type="file" id="settingsFileInput" accept=".json" style="display: none;" onchange="handleSettingsImport(event)">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
    initializeEventListeners();
});

function initializeEventListeners() {
    // Threshold range sliders
    const thresholdRanges = document.querySelectorAll('.threshold-range');
    thresholdRanges.forEach(range => {
        range.addEventListener('input', function() {
            const targetId = this.getAttribute('data-target');
            const targetElement = document.getElementById(targetId);
            targetElement.textContent = this.value + '%';
        });
    });

    // Form submission
    document.getElementById('settingsForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveSettings();
    });
}

function loadSettings() {
    // Load settings from localStorage or use defaults
    const settings = JSON.parse(localStorage.getItem('urlDetectionSettings')) || getDefaultSettings();
    
    // Apply settings to form
    document.getElementById('defaultModel').value = settings.defaultModel;
    document.getElementById('defaultDataset').value = settings.defaultDataset;
    
    document.getElementById('cnnThreshold').value = settings.thresholds.cnn;
    document.getElementById('cnnThresholdValue').textContent = settings.thresholds.cnn + '%';
    
    document.getElementById('xgbThreshold').value = settings.thresholds.xgb;
    document.getElementById('xgbThresholdValue').textContent = settings.thresholds.xgb + '%';
    
    document.getElementById('rfThreshold').value = settings.thresholds.rf;
    document.getElementById('rfThresholdValue').textContent = settings.thresholds.rf + '%';
    
    document.getElementById('enableCNN').checked = settings.enabledModels.cnn;
    document.getElementById('enableXGB').checked = settings.enabledModels.xgb;
    document.getElementById('enableRF').checked = settings.enabledModels.rf;
    
    document.getElementById('maxHistoryDays').value = settings.systemSettings.maxHistoryDays;
    document.getElementById('maxConcurrentRequests').value = settings.systemSettings.maxConcurrentRequests;
    document.getElementById('autoSave').checked = settings.systemSettings.autoSave;
    document.getElementById('enableNotifications').checked = settings.systemSettings.enableNotifications;
    document.getElementById('enableLogging').checked = settings.systemSettings.enableLogging;
    document.getElementById('enableCache').checked = settings.systemSettings.enableCache;
}

function saveSettings() {
    const settings = {
        defaultModel: document.getElementById('defaultModel').value,
        defaultDataset: document.getElementById('defaultDataset').value,
        thresholds: {
            cnn: parseInt(document.getElementById('cnnThreshold').value),
            xgb: parseInt(document.getElementById('xgbThreshold').value),
            rf: parseInt(document.getElementById('rfThreshold').value)
        },
        enabledModels: {
            cnn: document.getElementById('enableCNN').checked,
            xgb: document.getElementById('enableXGB').checked,
            rf: document.getElementById('enableRF').checked
        },
        systemSettings: {
            maxHistoryDays: parseInt(document.getElementById('maxHistoryDays').value),
            maxConcurrentRequests: parseInt(document.getElementById('maxConcurrentRequests').value),
            autoSave: document.getElementById('autoSave').checked,
            enableNotifications: document.getElementById('enableNotifications').checked,
            enableLogging: document.getElementById('enableLogging').checked,
            enableCache: document.getElementById('enableCache').checked
        },
        lastUpdated: new Date().toISOString()
    };
    
    // Save to localStorage
    localStorage.setItem('urlDetectionSettings', JSON.stringify(settings));
    
    // Show success message
    showAlert('Cài đặt đã được lưu thành công!', 'success');
    
    // Optional: Send to server
    fetch('/api/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    }).catch(error => {
        console.log('Could not sync settings to server:', error);
    });
}

function resetSettings() {
    if (confirm('Bạn có chắc chắn muốn đặt lại tất cả cài đặt về mặc định?')) {
        const defaultSettings = getDefaultSettings();
        localStorage.setItem('urlDetectionSettings', JSON.stringify(defaultSettings));
        loadSettings();
        showAlert('Cài đặt đã được đặt lại về mặc định!', 'info');
    }
}

function getDefaultSettings() {
    return {
        defaultModel: 'cnn',
        defaultDataset: 'dataset_1',
        thresholds: {
            cnn: 50,
            xgb: 50,
            rf: 50
        },
        enabledModels: {
            cnn: true,
            xgb: true,
            rf: true
        },
        systemSettings: {
            maxHistoryDays: 30,
            maxConcurrentRequests: 10,
            autoSave: true,
            enableNotifications: true,
            enableLogging: true,
            enableCache: true
        }
    };
}

function exportSettings() {
    const settings = JSON.parse(localStorage.getItem('urlDetectionSettings')) || getDefaultSettings();
    const dataStr = JSON.stringify(settings, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `url_detection_settings_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('Cài đặt đã được xuất thành công!', 'success');
}

function importSettings() {
    document.getElementById('settingsFileInput').click();
}

function handleSettingsImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const settings = JSON.parse(e.target.result);
            localStorage.setItem('urlDetectionSettings', JSON.stringify(settings));
            loadSettings();
            showAlert('Cài đặt đã được nhập thành công!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
        } catch (error) {
            showAlert('Lỗi: File cài đặt không hợp lệ!', 'danger');
        }
    };
    reader.readAsText(file);
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.glass-card');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}
