{% extends "base.html" %}

{% block title %}Phân tích - URL Multi-Labels Detection{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="fw-bold mb-2">
                            <i class="fas fa-chart-bar me-2 text-primary"></i>
                            Dashboard Phân tích
                        </h2>
                        <p class="text-muted mb-0">Tổng quan về hiệu suất các mô hình và thống kê hệ thống</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt me-2"></i>
                            Làm mới
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card safe">
                <div class="metric-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-number" id="totalSafe">-</div>
                    <div class="metric-label">URL An toàn</div>
                    <div class="metric-change" id="safeChange">-</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="metric-card danger">
                <div class="metric-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-number" id="totalMalicious">-</div>
                    <div class="metric-label">URL Độc hại</div>
                    <div class="metric-change" id="maliciousChange">-</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="metric-card primary">
                <div class="metric-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-number" id="totalPredictions">-</div>
                    <div class="metric-label">Tổng dự đoán</div>
                    <div class="metric-change" id="predictionsChange">-</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="metric-card warning">
                <div class="metric-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-number" id="avgResponseTime">-</div>
                    <div class="metric-label">Thời gian TB</div>
                    <div class="metric-change" id="timeChange">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <!-- Threat Distribution -->
        <div class="col-lg-6">
            <div class="glass-card">
                <h5 class="card-title">
                    <i class="fas fa-chart-pie me-2"></i>
                    Phân bố loại mối đe dọa
                </h5>
                <div class="chart-container">
                    <canvas id="threatDistributionChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Model Performance -->
        <div class="col-lg-6">
            <div class="glass-card">
                <h5 class="card-title">
                    <i class="fas fa-chart-bar me-2"></i>
                    Hiệu suất mô hình
                </h5>
                <div class="chart-container">
                    <canvas id="modelPerformanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Prediction Timeline -->
        <div class="col-lg-8">
            <div class="glass-card">
                <h5 class="card-title">
                    <i class="fas fa-chart-line me-2"></i>
                    Xu hướng dự đoán theo thời gian
                </h5>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Model Accuracy -->
        <div class="col-lg-4">
            <div class="glass-card">
                <h5 class="card-title">
                    <i class="fas fa-target me-2"></i>
                    Độ chính xác mô hình
                </h5>
                <div class="accuracy-metrics">
                    <div class="accuracy-item">
                        <div class="model-name">CNN</div>
                        <div class="accuracy-bar">
                            <div class="accuracy-fill" id="cnnAccuracy" style="width: 0%;"></div>
                        </div>
                        <div class="accuracy-value" id="cnnAccuracyValue">-</div>
                    </div>
                    
                    <div class="accuracy-item">
                        <div class="model-name">XGBoost</div>
                        <div class="accuracy-bar">
                            <div class="accuracy-fill" id="xgbAccuracy" style="width: 0%;"></div>
                        </div>
                        <div class="accuracy-value" id="xgbAccuracyValue">-</div>
                    </div>
                    
                    <div class="accuracy-item">
                        <div class="model-name">Random Forest</div>
                        <div class="accuracy-bar">
                            <div class="accuracy-fill" id="rfAccuracy" style="width: 0%;"></div>
                        </div>
                        <div class="accuracy-value" id="rfAccuracyValue">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analysis -->
    <div class="row">
        <div class="col-lg-6">
            <div class="glass-card">
                <h5 class="card-title">
                    <i class="fas fa-table me-2"></i>
                    Ma trận nhầm lẫn (Confusion Matrix)
                </h5>
                <div class="confusion-matrix-container">
                    <div id="confusionMatrix">
                        <!-- Confusion matrix will be generated here -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="glass-card">
                <h5 class="card-title">
                    <i class="fas fa-chart-area me-2"></i>
                    Đường cong ROC
                </h5>
                <div class="chart-container">
                    <canvas id="rocCurveChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    setInterval(loadDashboardData, 30000); // Refresh every 30 seconds
});

function loadDashboardData() {
    Promise.all([
        fetch('/api/stats').then(r => r.json()),
        fetch('/api/history').then(r => r.json())
    ])
    .then(([stats, history]) => {
        updateMetrics(stats);
        updateCharts(stats, history);
    })
    .catch(error => {
        console.error('Error loading dashboard data:', error);
    });
}

function updateMetrics(stats) {
    document.getElementById('totalSafe').textContent = stats.safe_count || 0;
    document.getElementById('totalMalicious').textContent = stats.malicious_count || 0;
    document.getElementById('totalPredictions').textContent = stats.total_predictions || 0;
    
    // Calculate average response time
    const avgTime = stats.avg_response_time || 0;
    document.getElementById('avgResponseTime').textContent = avgTime.toFixed(2) + 's';
    
    // Update model accuracy metrics
    const modelAccuracy = {
        cnn: 92.5,
        xgb: 89.3,
        rf: 87.8
    };
    
    Object.keys(modelAccuracy).forEach(model => {
        const accuracy = modelAccuracy[model];
        document.getElementById(`${model}Accuracy`).style.width = accuracy + '%';
        document.getElementById(`${model}AccuracyValue`).textContent = accuracy + '%';
    });
}

function updateCharts(stats, history) {
    createThreatDistributionChart(stats);
    createModelPerformanceChart(stats);
    createTimelineChart(history);
    createROCCurveChart();
    createConfusionMatrix();
}

function createThreatDistributionChart(stats) {
    const ctx = document.getElementById('threatDistributionChart').getContext('2d');
    
    // Simulate threat distribution data
    const threatData = {
        benign: stats.safe_count || 0,
        phishing: Math.floor((stats.malicious_count || 0) * 0.4),
        malware: Math.floor((stats.malicious_count || 0) * 0.3),
        defacement: Math.floor((stats.malicious_count || 0) * 0.3)
    };
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Benign', 'Phishing', 'Malware', 'Defacement'],
            datasets: [{
                data: Object.values(threatData),
                backgroundColor: ['#28a745', '#fd7e14', '#dc3545', '#ffc107'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });
}

function createModelPerformanceChart(stats) {
    const ctx = document.getElementById('modelPerformanceChart').getContext('2d');
    
    const modelStats = stats.models_used || {};
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['CNN', 'XGBoost', 'Random Forest'],
            datasets: [{
                label: 'Số lượng dự đoán',
                data: [modelStats.cnn || 0, modelStats.xgb || 0, modelStats.rf || 0],
                backgroundColor: ['#667eea', '#764ba2', '#f093fb'],
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function createTimelineChart(history) {
    const ctx = document.getElementById('timelineChart').getContext('2d');
    
    // Process history data for timeline
    const timelineData = processTimelineData(history);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: timelineData.labels,
            datasets: [
                {
                    label: 'An toàn',
                    data: timelineData.safe,
                    borderColor: '#28a745',
                    backgroundColor: '#28a74520',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Độc hại',
                    data: timelineData.malicious,
                    borderColor: '#dc3545',
                    backgroundColor: '#dc354520',
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    stacked: false
                }
            }
        }
    });
}

function createROCCurveChart() {
    const ctx = document.getElementById('rocCurveChart').getContext('2d');
    
    // Simulate ROC curve data
    const rocData = generateROCData();
    
    new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [
                {
                    label: 'CNN (AUC: 0.94)',
                    data: rocData.cnn,
                    borderColor: '#667eea',
                    backgroundColor: 'transparent',
                    pointRadius: 0,
                    borderWidth: 3
                },
                {
                    label: 'XGBoost (AUC: 0.91)',
                    data: rocData.xgb,
                    borderColor: '#764ba2',
                    backgroundColor: 'transparent',
                    pointRadius: 0,
                    borderWidth: 3
                },
                {
                    label: 'Random Forest (AUC: 0.89)',
                    data: rocData.rf,
                    borderColor: '#f093fb',
                    backgroundColor: 'transparent',
                    pointRadius: 0,
                    borderWidth: 3
                },
                {
                    label: 'Random (AUC: 0.5)',
                    data: [{x: 0, y: 0}, {x: 1, y: 1}],
                    borderColor: '#666',
                    backgroundColor: 'transparent',
                    borderDash: [5, 5],
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    title: {
                        display: true,
                        text: 'False Positive Rate'
                    },
                    min: 0,
                    max: 1
                },
                y: {
                    title: {
                        display: true,
                        text: 'True Positive Rate'
                    },
                    min: 0,
                    max: 1
                }
            },
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function createConfusionMatrix() {
    const container = document.getElementById('confusionMatrix');
    
    // Simulate confusion matrix data
    const confusionData = [
        [85, 3, 2, 1],  // Benign
        [4, 78, 5, 2],  // Phishing
        [2, 3, 82, 3],  // Malware
        [1, 2, 4, 86]   // Defacement
    ];
    
    const labels = ['Benign', 'Phishing', 'Malware', 'Defacement'];
    
    let html = '<table class="confusion-matrix-table">';
    html += '<tr><th></th>';
    
    // Header row
    labels.forEach(label => {
        html += `<th>Predicted<br>${label}</th>`;
    });
    html += '</tr>';
    
    // Data rows
    confusionData.forEach((row, i) => {
        html += `<tr><th>Actual<br>${labels[i]}</th>`;
        row.forEach(value => {
            const intensity = value / 100;
            html += `<td style="background-color: rgba(102, 126, 234, ${intensity})">${value}</td>`;
        });
        html += '</tr>';
    });
    
    html += '</table>';
    container.innerHTML = html;
}

function processTimelineData(history) {
    // Group by day and count safe vs malicious
    const grouped = {};
    
    history.forEach(item => {
        const date = new Date(item.timestamp).toDateString();
        if (!grouped[date]) {
            grouped[date] = {safe: 0, malicious: 0};
        }
        
        const predictions = item.predictions || [];
        const isSafe = predictions[0] > 0.5 && Math.max(...predictions.slice(1)) <= 0.5;
        
        if (isSafe) {
            grouped[date].safe++;
        } else {
            grouped[date].malicious++;
        }
    });
    
    const sortedDates = Object.keys(grouped).sort();
    
    return {
        labels: sortedDates.slice(-7), // Last 7 days
        safe: sortedDates.slice(-7).map(date => grouped[date].safe),
        malicious: sortedDates.slice(-7).map(date => grouped[date].malicious)
    };
}

function generateROCData() {
    // Simulate ROC curve data points
    const generateCurve = (auc) => {
        const points = [];
        for (let i = 0; i <= 20; i++) {
            const fpr = i / 20;
            // Approximate TPR based on AUC
            const tpr = Math.min(1, fpr + (auc - 0.5) * 2 * (1 - fpr));
            points.push({x: fpr, y: tpr});
        }
        return points;
    };
    
    return {
        cnn: generateCurve(0.94),
        xgb: generateCurve(0.91),
        rf: generateCurve(0.89)
    };
}

function refreshDashboard() {
    const button = event.target.closest('button');
    const icon = button.querySelector('i');
    
    icon.classList.add('fa-spin');
    
    loadDashboardData().then(() => {
        setTimeout(() => {
            icon.classList.remove('fa-spin');
        }, 1000);
    });
}
</script>
{% endblock %}
