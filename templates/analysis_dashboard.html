{% extends "base.html" %}

{% block title %}Phân tích - URL Multi-Labels Detection{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="fw-bold mb-2">
                            <i class="fas fa-chart-bar me-2 text-primary"></i>
                            Dashboard Phân tích
                        </h2>
                        <p class="text-muted mb-0">Tổng quan về hiệu suất các mô hình và thống kê hệ thống</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt me-2"></i>
                            Làm mới
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card safe">
                <div class="metric-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-number" id="totalSafe">-</div>
                    <div class="metric-label">URL An toàn</div>
                    <div class="metric-change" id="safeChange">-</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="metric-card primary">
                <div class="metric-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-number" id="totalPredictions">-</div>
                    <div class="metric-label">Tổng dự đoán</div>
                    <div class="metric-change" id="predictionsChange">-</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="metric-card warning">
                <div class="metric-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-number" id="avgResponseTime">-</div>
                    <div class="metric-label">Thời gian TB</div>
                    <div class="metric-change" id="timeChange">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Benign and Malicious URL Breakdown -->
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="mb-3"><i class="fas fa-tasks me-2"></i>Phân loại dự đoán</h4>
        </div>
        <div class="col-md-3">
            <div class="metric-card-small benign">
                <div class="metric-icon-small"><i class="fas fa-shield-alt"></i></div>
                <div class="metric-content-small">
                    <div class="metric-number" id="benignCount">-</div>
                    <div class="metric-label">An toàn</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card-small phishing">
                <div class="metric-icon-small"><i class="fas fa-fish"></i></div>
                <div class="metric-content-small">
                    <div class="metric-number" id="phishingCount">-</div>
                    <div class="metric-label">Phishing</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card-small defacement">
                <div class="metric-icon-small"><i class="fas fa-paint-roller"></i></div>
                <div class="metric-content-small">
                    <div class="metric-number" id="defacementCount">-</div>
                    <div class="metric-label">Defacement</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card-small malware">
                <div class="metric-icon-small"><i class="fas fa-virus"></i></div>
                <div class="metric-content-small">
                    <div class="metric-number" id="malwareCount">-</div>
                    <div class="metric-label">Malware</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <!-- Threat Distribution -->
        <div class="col-lg-6">
            <div class="glass-card">
                <h5 class="card-title">
                    <i class="fas fa-chart-pie me-2"></i>
                    Phân bố loại mối đe dọa
                </h5>
                <div class="chart-container">
                    <canvas id="threatDistributionChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Model Performance -->
        <div class="col-lg-6">
            <div class="glass-card">
                <h5 class="card-title">
                    <i class="fas fa-chart-bar me-2"></i>
                    Hiệu suất mô hình
                </h5>
                <div class="chart-container">
                    <canvas id="modelPerformanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Prediction Timeline -->
        <div class="col-lg-8">
            <div class="glass-card">
                <h5 class="card-title">
                    <i class="fas fa-chart-line me-2"></i>
                    Xu hướng dự đoán theo thời gian
                </h5>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Model Accuracy -->
        <div class="col-lg-4">
            <div class="glass-card">
                <h5 class="card-title">
                    <i class="fas fa-target me-2"></i>
                    Độ chính xác mô hình
                </h5>
                <div class="accuracy-metrics">
                    <div class="accuracy-item">
                        <div class="model-name">CNN</div>
                        <div class="accuracy-bar">
                            <div class="accuracy-fill" id="cnnAccuracy" style="width: 92.5%;"></div>
                        </div>
                        <div class="accuracy-value" id="cnnAccuracyValue">92.5%</div>
                    </div>
                    
                    <div class="accuracy-item">
                        <div class="model-name">XGBoost</div>
                        <div class="accuracy-bar">
                            <div class="accuracy-fill" id="xgbAccuracy" style="width: 97.8%;"></div>
                        </div>
                        <div class="accuracy-value" id="xgbAccuracyValue">97.8%</div>
                    </div>
                    
                    <div class="accuracy-item">
                        <div class="model-name">Random Forest</div>
                        <div class="accuracy-bar">
                            <div class="accuracy-fill" id="rfAccuracy" style="width: 98.1%;"></div>
                        </div>
                        <div class="accuracy-value" id="rfAccuracyValue">98.1%</div>
                    </div>
                    
                    <div class="accuracy-item">
                        <div class="model-name">BERT</div>
                        <div class="accuracy-bar">
                            <div class="accuracy-fill" id="bertAccuracy" style="width: 98.4%;"></div>
                        </div>
                        <div class="accuracy-value" id="bertAccuracyValue">98.4%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Analysis Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card">
                <h5 class="card-title mb-4">
                    <i class="fas fa-microscope me-2"></i>
                    Phân tích chi tiết mô hình
                </h5>
                
                <!-- Model Selection Controls -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label for="dashboardModelSelect" class="form-label">
                            <i class="fas fa-robot me-2"></i>Chọn mô hình:
                        </label>
                        <select class="form-select" id="dashboardModelSelect" onchange="updateDashboardModelAnalysis()">
                            <option value="BERT">BERT - Transformer Model</option>
                            <option value="CNN1">CNN Model 1 - Deep Learning</option>
                            <option value="CNN2">CNN Model 2 - Deep Learning</option>
                            <option value="XGB1">XGBoost Model 1 - Gradient Boosting</option>
                            <option value="XGB2">XGBoost Model 2 - Gradient Boosting</option>
                            <option value="RF1">Random Forest Model 1 - Ensemble</option>
                            <option value="RF2">Random Forest Model 2 - Ensemble</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="dashboardMetricSelect" class="form-label">
                            <i class="fas fa-chart-bar me-2"></i>Chọn loại biểu đồ:
                        </label>
                        <select class="form-select" id="dashboardMetricSelect" onchange="updateDashboardModelAnalysis()">
                            <option value="CONF_MATRIX">Ma trận nhầm lẫn</option>
                            <option value="PR_AUC">Precision-Recall & AUC</option>
                            <option value="ACC_LOSS">Accuracy & Loss Graph</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button class="btn btn-outline-primary w-100" onclick="updateDashboardModelAnalysis()">
                            <i class="fas fa-sync-alt me-2"></i>Cập nhật
                        </button>
                    </div>
                </div>

                <!-- Image Display Area -->
                <div class="row">
                    <div class="col-12">
                        <div class="dashboard-image-container">
                            <div class="text-center" id="dashboardImageContainer">
                                <img id="dashboardAnalysisImage" 
                                     src="{{ url_for('static', filename='images/dataset_1/BERT_CONF_MATRIX.png') }}" 
                                     alt="Model Analysis" 
                                     class="img-fluid dashboard-analysis-image">
                                <div class="mt-3">
                                    <h6 id="dashboardImageTitle">BERT - Ma trận nhầm lẫn</h6>
                                    <p class="text-muted small" id="dashboardImageDescription">
                                        Ma trận nhầm lẫn thể hiện khả năng phân loại chính xác của mô hình BERT
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analysis -->
    <div class="row">
        <div class="col-lg-6">
            <div class="glass-card">
                <h5 class="card-title">
                    <i class="fas fa-table me-2"></i>
                    Ma trận nhầm lẫn (Confusion Matrix)
                </h5>
                <div class="confusion-matrix-container">
                    <div id="confusionMatrix">
                        <!-- Confusion matrix will be generated here -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="glass-card">
                <h5 class="card-title">
                    <i class="fas fa-chart-area me-2"></i>
                    Đường cong ROC
                </h5>
                <div class="chart-container">
                    <canvas id="rocCurveChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
async function loadDashboardData() {
    try {
        console.log('Loading dashboard data...');
        
        // Show loading state for all metrics
        const loadingElements = [
            'totalSafe', 'totalPredictions', 'avgResponseTime',
            'benignCount', 'phishingCount', 'defacementCount', 'malwareCount',
            'cnnAccuracyValue', 'xgbAccuracyValue', 'rfAccuracyValue', 'bertAccuracyValue'
        ];
        
        loadingElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.textContent = 'Loading...';
        });

        const response = await fetch('/api/stats');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Dashboard API response:', data);

        // Update key metrics
        const labelStats = data.label_stats || {};
        const modelPerformance = data.model_performance || {};
        
        // Main metrics cards
        updateMetricElement('totalSafe', labelStats.safe_count || 0);
        updateMetricElement('totalPredictions', labelStats.total_count || data.total_predictions || 0);
        updateMetricElement('avgResponseTime', '~150ms'); // Placeholder - could be calculated from execution times
        
        // Label-specific counts
        updateMetricElement('benignCount', labelStats.benign_count || 0);
        updateMetricElement('phishingCount', labelStats.phishing_count || 0);
        updateMetricElement('defacementCount', labelStats.defacement_count || 0);
        updateMetricElement('malwareCount', labelStats.malware_count || 0);

        // Model accuracy metrics
        Object.keys(modelPerformance).forEach(modelKey => {
            const performance = modelPerformance[modelKey];
            const accuracyElementId = `${modelKey}AccuracyValue`;
            const accuracyBarId = `${modelKey}Accuracy`;
            
            if (performance.accuracy) {
                const accuracyPercent = (performance.accuracy * 100).toFixed(1);
                updateMetricElement(accuracyElementId, `${accuracyPercent}%`);
                
                // Update accuracy bar width
                const accuracyBar = document.getElementById(accuracyBarId);
                if (accuracyBar) {
                    accuracyBar.style.width = `${accuracyPercent}%`;
                }
            }
        });

        // Update charts with real data
        if (data.timeline_data && data.timeline_data.length > 0) {
            updateTimelineChart(data.timeline_data);
        }
        
        updateThreatDistributionChart(labelStats);
        updateModelPerformanceChart(modelPerformance);
        
        // Update change indicators (simulate trends)
        updateChangeIndicators(data);
        
        console.log('Dashboard data loaded successfully');
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        
        // Show error state
        const errorElements = [
            'totalSafe', 'totalPredictions', 'avgResponseTime',
            'benignCount', 'phishingCount', 'defacementCount', 'malwareCount'
        ];
        
        errorElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.textContent = 'Error';
        });
        
        showDashboardNotification('Không thể tải dữ liệu dashboard. Vui lòng thử lại.', 'error');
    }
}

// Helper function to update metric elements
function updateMetricElement(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = typeof value === 'number' ? value.toLocaleString() : value;
    }
}

// Update timeline chart with real data
function updateTimelineChart(timelineData) {
    const ctx = document.getElementById('timelineChart');
    if (!ctx) return;

    // Destroy existing chart if it exists
    if (window.timelineChartInstance) {
        window.timelineChartInstance.destroy();
    }

    const labels = timelineData.map(item => {
        const date = new Date(item.date);
        return date.toLocaleDateString('vi-VN', { month: 'short', day: 'numeric' });
    });
    
    const safeData = timelineData.map(item => item.safe || 0);
    const maliciousData = timelineData.map(item => item.malicious || 0);

    window.timelineChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'URL An toàn',
                    data: safeData,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'URL Độc hại',
                    data: maliciousData,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// Update threat distribution chart
function updateThreatDistributionChart(labelStats) {
    const ctx = document.getElementById('threatDistributionChart');
    if (!ctx) return;

    // Destroy existing chart if it exists
    if (window.threatChartInstance) {
        window.threatChartInstance.destroy();
    }

    const data = [
        labelStats.benign_count || 0,
        labelStats.phishing_count || 0,
        labelStats.defacement_count || 0,
        labelStats.malware_count || 0
    ];

    window.threatChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['An toàn', 'Phishing', 'Defacement', 'Malware'],
            datasets: [{
                data: data,
                backgroundColor: [
                    '#28a745',
                    '#dc3545',
                    '#ffc107',
                    '#6f42c1'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Update model performance chart
function updateModelPerformanceChart(modelPerformance) {
    const ctx = document.getElementById('modelPerformanceChart');
    if (!ctx) return;

    // Destroy existing chart if it exists
    if (window.performanceChartInstance) {
        window.performanceChartInstance.destroy();
    }

    const models = Object.keys(modelPerformance);
    const accuracyData = models.map(model => 
        modelPerformance[model].accuracy ? (modelPerformance[model].accuracy * 100) : 0
    );
    const predictionCounts = models.map(model => 
        modelPerformance[model].predictions || 0
    );

    window.performanceChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: models.map(m => m.toUpperCase()),
            datasets: [
                {
                    label: 'Độ chính xác (%)',
                    data: accuracyData,
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    label: 'Số lượng dự đoán',
                    data: predictionCounts,
                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    max: 100,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Độ chính xác (%)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Số lượng dự đoán'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
}

// Update change indicators with trend simulation
function updateChangeIndicators(data) {
    const indicators = [
        { id: 'safeChange', value: '+12%', positive: true },
        { id: 'predictionsChange', value: '+8%', positive: true },
        { id: 'timeChange', value: '-5%', positive: true }
    ];

    indicators.forEach(indicator => {
        const element = document.getElementById(indicator.id);
        if (element) {
            element.textContent = indicator.value;
            element.className = `metric-change ${indicator.positive ? 'positive' : 'negative'}`;
        }
    });
}

// Show dashboard notification
function showDashboardNotification(message, type = 'info') {
    // Create or update notification
    let notification = document.getElementById('dashboardNotification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'dashboardNotification';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        `;
        document.body.appendChild(notification);
    }

    const colors = {
        success: '#28a745',
        error: '#dc3545',
        warning: '#ffc107',
        info: '#17a2b8'
    };
    
    notification.style.backgroundColor = colors[type] || colors.info;
    notification.textContent = message;
    notification.style.transform = 'translateX(0)';
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
    }, 5000);
}

// Dashboard-specific image mapping
const dashboardImageMapping = {
    'BERT': {
        'CONF_MATRIX': 'BERT_CONF_MATRIX.png',
        'PR_AUC': 'BERT_PR_AUC.png',
        'ACC_LOSS': 'BERT_ACC_LOSS_GRAPH.png'
    },
    'CNN1': {
        'CONF_MATRIX': 'CNN1_CONF_MATRX.png',
        'PR_AUC': 'CNN1_PR_AUC.png',
        'ACC_LOSS': 'CNN1_ACC_LOSS_GRAPH.png'
    },
    'CNN2': {
        'CONF_MATRIX': 'CNN2_CONF_MATRX.png',
        'PR_AUC': 'CNN2_PR_AUC.png',
        'ACC_LOSS': 'CNN2_ACC_LOSS_GRAPH.png'
    },
    'XGB1': {
        'CONF_MATRIX': 'XGB1_CONF_MATRX.png',
        'PR_AUC': 'XGB1_PR_AUC.png',
        'ACC_LOSS': 'XGB1_ACC_LOSS_GRAPH.png'
    },
    'XGB2': {
        'CONF_MATRIX': 'XGB2_CONF_MATRX.png',
        'PR_AUC': 'XGB2_PR_AUC.png',
        'ACC_LOSS': 'XGB2_ACC_LOSS_GRAPH.png'
    },
    'RF1': {
        'CONF_MATRIX': 'RF1_CONF_MATRX.png',
        'PR_AUC': 'RF1_PR_AUC.png',
        'ACC_LOSS': 'RF1_CONF_MATRX.png'
    },
    'RF2': {
        'CONF_MATRIX': 'RF2_CONF_MATRX.png',
        'PR_AUC': 'RF2_PR_AUC.png',
        'ACC_LOSS': 'RF2_CONF_MATRX.png'
    }
};

const dashboardModelNames = {
    'BERT': 'BERT - Transformer Model',
    'CNN1': 'CNN Model 1 - Deep Learning',
    'CNN2': 'CNN Model 2 - Deep Learning',
    'XGB1': 'XGBoost Model 1 - Gradient Boosting',
    'XGB2': 'XGBoost Model 2 - Gradient Boosting',
    'RF1': 'Random Forest Model 1 - Ensemble',
    'RF2': 'Random Forest Model 2 - Ensemble'
};

const dashboardMetricDescriptions = {
    'CONF_MATRIX': 'Ma trận nhầm lẫn thể hiện khả năng phân loại chính xác của mô hình',
    'PR_AUC': 'Biểu đồ Precision-Recall và AUC thể hiện hiệu suất phân loại',
    'ACC_LOSS': 'Biểu đồ Accuracy và Loss trong quá trình huấn luyện'
};

function updateDashboardModelAnalysis() {
    const modelSelect = document.getElementById('dashboardModelSelect');
    const metricSelect = document.getElementById('dashboardMetricSelect');
    const selectedModel = modelSelect.value;
    const selectedMetric = metricSelect.value;
    
    // Use dynamic backend API for image URLs
    const metricMapping = {
        'CONF_MATRIX': 'confusion_matrix',
        'PR_AUC': 'pr_auc',
        'ACC_LOSS': 'accuracy_loss'
    };
    
    const backendMetric = metricMapping[selectedMetric];
    const imageApiUrl = `/api/model-image/${selectedModel}/${backendMetric}`;
    
    // Fetch image URL from backend API
    fetch(imageApiUrl)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading image:', data.error);
                // Fallback to direct path
                const imageName = dashboardImageMapping[selectedModel][selectedMetric];
                const imageUrl = `/images/dataset_1/${imageName}`;
                updateImageDisplay(imageUrl, selectedModel, selectedMetric);
            } else {
                updateImageDisplay(data.image_url, selectedModel, selectedMetric);
            }
        })
        .catch(error => {
            console.error('API error:', error);
            // Fallback to direct path
            const imageName = dashboardImageMapping[selectedModel][selectedMetric];
            const imageUrl = `/images/dataset_1/${imageName}`;
            updateImageDisplay(imageUrl, selectedModel, selectedMetric);
        });
}

function updateImageDisplay(imageUrl, selectedModel, selectedMetric) {
    // Update image
    const analysisImage = document.getElementById('dashboardAnalysisImage');
    analysisImage.src = imageUrl;
    analysisImage.alt = `${selectedModel} - ${selectedMetric}`;
    
    // Update title and description
    const imageTitle = document.getElementById('dashboardImageTitle');
    const imageDescription = document.getElementById('dashboardImageDescription');
    
    const metricSelect = document.getElementById('dashboardMetricSelect');
    const metricName = metricSelect.options[metricSelect.selectedIndex].text;
    imageTitle.textContent = `${dashboardModelNames[selectedModel]} - ${metricName}`;
    imageDescription.textContent = `${dashboardMetricDescriptions[selectedMetric]} cho mô hình ${selectedModel}`;
}

document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    setInterval(loadDashboardData, 30000); // Refresh every 30 seconds
    updateDashboardModelAnalysis(); // Initialize model analysis
});

function refreshDashboard() {
    const button = event.target.closest('button');
    const icon = button.querySelector('i');
    
    icon.classList.add('fa-spin');
    
    loadDashboardData().then(() => {
        setTimeout(() => {
            icon.classList.remove('fa-spin');
        }, 1000);
    });
}
</script>
{% endblock %}
